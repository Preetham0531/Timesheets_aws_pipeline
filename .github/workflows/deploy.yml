name: Deploy Timesheets Lambdas

on:
  push:
    branches:
      - main
    paths:
      - 'approvals/**'
      - 'client_table/**'
      - 'contacts/**'
      - 'dashboard/**'
      - 'iam/**'
      - 'lookup/**'
      - 'projects_table/**'
      - 'project_assignment/**'
      - 'tasks/**'
      - 'timeentries/**'
      - 'update_password/**'
      - 'user_login/**'
      - 'user_routes/**'
      - '.github/workflows/deploy.yml'
      - 'template.yaml'

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.filter.outputs.changed }}
      template_changed: ${{ steps.templ.outputs.template_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - id: filter
        run: |
          # Ensure jq is available
          if ! command -v jq >/dev/null 2>&1; then
            echo "Installing jq..."
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # Prefer GitHub provided range when available, fallback to HEAD^..HEAD
          RANGE=${{ github.event.before }}..${{ github.event.after }}
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            RANGE=HEAD^..HEAD
          fi

          CHANGED=$(git diff --name-only $RANGE | grep -E '^(approvals|client_table|contacts|dashboard|iam|lookup|projects_table|project_assignment|tasks|timeentries|update_password|user_login|user_routes)/' | cut -d/ -f1 | sort -u | tr '\n' ' ')
          echo "Modules changed: $CHANGED"
          if [ -z "$CHANGED" ]; then
            echo "changed=" >> $GITHUB_OUTPUT
          else
            # Build JSON array for matrix
            JSON=$(echo $CHANGED | jq -R -s -c 'split(" ")[:-1]')
            echo "changed=$JSON" >> $GITHUB_OUTPUT
          fi

      - id: templ
        run: |
          RANGE=${{ github.event.before }}..${{ github.event.after }}
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            RANGE=HEAD^..HEAD
          fi
          if git diff --name-only $RANGE | grep -q '^template.yaml$'; then
            echo "template_changed=true" >> $GITHUB_OUTPUT
          else
            echo "template_changed=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.changed != '' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.changed) }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::026090520154:role/aws_github
          aws-region: us-east-1

      - name: Zip function code
        run: |
          MOD="${{ matrix.module }}"
          echo "Zipping module: $MOD"
          cd "$MOD"
          zip -r "../function-$MOD.zip" .
          cd -

      - name: Update Lambda function code
        run: |
          MOD="${{ matrix.module }}"
          FN_NAME="$MOD-handler"
          ZIP_PATH="function-$MOD.zip"
          echo "Updating function $FN_NAME with $ZIP_PATH"
          aws lambda update-function-code \
            --function-name "$FN_NAME" \
            --zip-file "fileb://$ZIP_PATH" \
            --region us-east-1

      - name: Show last modified time
        run: |
          MOD="${{ matrix.module }}"
          FN_NAME="$MOD-handler"
          aws lambda get-function-configuration \
            --function-name "$FN_NAME" \
            --query 'LastModified' \
            --output text \
            --region us-east-1
